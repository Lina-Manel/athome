<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Red vs Blue Islamic Game</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f0f4f8; text-align:center; margin:0; }
  h1 { margin-top:20px; color:#333; }
  .screen { display:none; padding:20px; transition: all 0.3s ease; }
  .active { display:block; }
  .team-btn { padding:20px 50px; margin:20px; font-size:22px; border:none; color:white; border-radius:15px; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.2); transition:0.3s; }
  .team-btn:hover { transform: translateY(-3px); }
  .team-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .section { background:white; padding:20px; margin:15px auto; width:80%; max-width:450px; border-radius:15px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.15); transition:0.2s; }
  .section:hover { transform: translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.2); }
  .locked { background:#ddd; cursor:not-allowed; }
  #questionBox { background:white; padding:25px; width:85%; max-width:500px; margin:20px auto; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  #questionBox button { padding:12px 25px; margin:10px; font-size:18px; cursor:pointer; border:none; border-radius:10px; transition:0.2s; background:#2196f3; color:white; }
  #questionBox button:hover { transform: scale(1.05); }
  #scoreScreen button { padding:15px 30px; font-size:20px; background:#ff9800; color:white; border:none; border-radius:12px; cursor:pointer; transition:0.2s; }
  #scoreScreen button:hover { transform: translateY(-3px); }
  .current-score { position: fixed; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .waiting { color: #666; font-style: italic; }
  #timer { position: fixed; top: 10px; left: 10px; background:white; padding: 12px 18px; border-radius:10px; font-size:18px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h1>Red vs Blue Islamic Game</h1>

<div id="timer">‚è±Ô∏è 30:00</div>

<div class="current-score" id="liveScore" style="display:none;">
  <div>üî¥ Red: <span id="redScoreLive">0</span></div>
  <div>üîµ Blue: <span id="blueScoreLive">0</span></div>
</div>

<!-- TEAM SELECTION -->
<div id="teamScreen" class="screen active">
  <h2>Choose your team</h2>
  <p id="teamStatus">Waiting for both teams to join...</p>
  <button class="team-btn red" id="redBtn" onclick="joinTeam('red')">Red Team üî¥</button>
  <button class="team-btn blue" id="blueBtn" onclick="joinTeam('blue')">Blue Team üîµ</button>
  <p class="waiting" id="waitingMsg" style="display:none;">Waiting for other team...</p>
</div>

<!-- SECTION SELECTION -->
<div id="sectionScreen" class="screen">
  <h2 id="sectionTitle">Pick a Section</h2>
  <div id="sections"></div>
</div>

<!-- QUESTION SCREEN -->
<div id="questionScreen" class="screen">
  <div id="questionBox"></div>
</div>

<!-- SCORE SCREEN -->
<div id="scoreScreen" class="screen">
  <h2>Final Score</h2>
  <p id="scoreText"></p>
  <button onclick="resetGame()">Restart Game</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ========== FIREBASE CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAKP0ovl9ZERz9pHgdy-bNSD8GDtvDjmnc",
  authDomain: "athome-8dca5.firebaseapp.com",
  databaseURL: "https://athome-8dca5-default-rtdb.firebaseio.com",
  projectId: "athome-8dca5",
  storageBucket: "athome-8dca5.firebasestorage.app",
  messagingSenderId: "720555193634",
  appId: "1:720555193634:web:262b9a01b9dc3191cca17b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

db.ref("game").remove();

/* ========== GAME STATE ========== */
let gameState = {
  team: null,
  currentSection: null,
  currentQuestionIndex: 0,
  currentQuestions: [],
  lockedSections: {},
  timeUp: false
};

/* ========== CONNECTION ========== */
const myID = "u_" + Math.random().toString(36).substr(2,9);
db.ref("game/players/"+myID).set(true);
db.ref("game/players/"+myID).onDisconnect().remove();

/* ========== TEAM JOIN ========== */
function joinTeam(team) {
  gameState.team = team;

  db.ref("game/redScore").once("value").then(snap => { if(snap.val() === null) db.ref("game/redScore").set(0); });
  db.ref("game/blueScore").once("value").then(snap => { if(snap.val() === null) db.ref("game/blueScore").set(0); });

  db.ref("game/teams/"+team).transaction(t => {
    if(t) return {...t, joined:true, count:(t.count||0)+1};
    return {joined:true, count:1};
  });

  document.getElementById("redBtn").disabled = true;
  document.getElementById("blueBtn").disabled = true;
  document.getElementById("waitingMsg").style.display = "block";
}

/* ========== LISTEN TEAMS ========== */
db.ref("game/teams").on("value", snap => {
  const data = snap.val() || {};
  const redJoined = data.red?.joined || false;
  const blueJoined = data.blue?.joined || false;

  document.getElementById("teamStatus").innerHTML = `Red: ${redJoined?"‚úîÔ∏è":"‚ùå"} | Blue: ${blueJoined?"‚úîÔ∏è":"‚ùå"}`;

  if(redJoined && blueJoined && gameState.team && !gameState.timeUp) {
    showScreen("sectionScreen");
    document.getElementById("liveScore").style.display = "block";
    loadSections();
    startTimer();
  }
});

/* ========== LISTEN SCORES ========== */
db.ref("game/redScore").on("value", snap => {
  document.getElementById("redScoreLive").textContent = snap.val() || 0;
});
db.ref("game/blueScore").on("value", snap => {
  document.getElementById("blueScoreLive").textContent = snap.val() || 0;
});

/* ========== SECTIONS ========== */
db.ref("game/lockedSections").on("value", snap => {
  gameState.lockedSections = snap.val() || {};
  if(document.getElementById("sectionScreen").classList.contains("active")) loadSections();

  const totalSections = Object.keys(sections).length;
  const takenSections = Object.values(gameState.lockedSections).filter(v=>v==="red"||v==="blue").length;

  if(takenSections === totalSections || gameState.timeUp) showScore();
});

function loadSections() {
  const container = document.getElementById("sections");
  container.innerHTML = "";

  document.getElementById("sectionTitle").innerHTML = `${gameState.team === "red" ? "Red Team üî¥" : "Blue Team üîµ"} - Pick a Section`;

  Object.keys(sections).forEach(sec => {
    const div = document.createElement("div");
    div.className = "section";

    const takenBy = gameState.lockedSections[sec];
    if(takenBy) {
      div.innerHTML = sec + ` ${takenBy === "red" ? "üî¥" : takenBy === "blue" ? "üîµ" : "‚è∞"} (Taken)`;
      div.classList.add("locked");
      div.onclick = null;
    } else {
      div.innerHTML = sec;
      div.onclick = () => pickSection(sec);
    }

    container.appendChild(div);
  });
}

function pickSection(sec) {
  if(gameState.timeUp) return;

  const ref = db.ref("game/lockedSections/"+sec);
  ref.transaction(current => {
    if(current) return; // already taken
    return gameState.team;
  }, (err, committed, snapshot) => {
    if(!committed) {
      alert("Sorry, this section was just taken!");
      return;
    }

    gameState.currentSection = sec;
    gameState.currentQuestions = sections[sec];
    gameState.currentQuestionIndex = 0;

    showQuestion(gameState.currentQuestions[0]);
  });
}

/* ========== QUESTIONS ========== */
function showQuestion(q) {
  showScreen("questionScreen");
  const qNum = gameState.currentQuestionIndex + 1;
  const qType = q.type === "tf" ? "True/False" : q.type === "mcq" ? "Multiple Choice" : "Hadith";

  let html = `<h3>${gameState.team === "red" ? "Red Team üî¥" : "Blue Team üîµ"}</h3>
              <p style="color:#666; font-size:14px;">${gameState.currentSection} - ${qType} (${qNum}/3)</p>
              <p style="font-size:20px; margin:20px 0;">${q.q}</p>`;

  if(q.type === "tf") {
    html += `<button onclick="answer(true)">‚úîÔ∏è True</button>
             <button onclick="answer(false)">‚ùå False</button>`;
  } else if(q.type === "mcq" || q.type === "hadith") {
    q.options.forEach((opt, i) => {
      const letter = String.fromCharCode(65 + i);
      html += `<button onclick="answer('${letter}')">${opt}</button>`;
    });
  }

  document.getElementById("questionBox").innerHTML = html;
}

function answer(selected) {
  if(gameState.timeUp) return;

  const q = gameState.currentQuestions[gameState.currentQuestionIndex];
  if(!q) return;

  let isCorrect = (typeof q.a === "boolean") ? (selected === q.a)
                 : (selected.toString().trim().toUpperCase() === q.a.toString().trim().toUpperCase());

  if(isCorrect) {
    const scorePath = `game/${gameState.team}Score`;
    db.ref(scorePath).transaction(s => (s||0)+1);
    alert("‚úîÔ∏è Correct!");
  } else {
    alert("‚ùå Wrong! The correct answer was: " + q.a);
  }

  gameState.currentQuestionIndex++;
  if(gameState.currentQuestionIndex < gameState.currentQuestions.length)
    showQuestion(gameState.currentQuestions[gameState.currentQuestionIndex]);
  else
    showScreen("sectionScreen");
}

/* ========== TIMER ========== */
let timerInterval;
function startTimer() {
  if(timerInterval) return;

  let timeLeft = 30*60;
  updateTimerDisplay(timeLeft);

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay(timeLeft);

    if(timeLeft <= 0) {
      clearInterval(timerInterval);
      db.ref("game/timeUp").set(true);
    }
  }, 1000);
}

db.ref("game/timeUp").on("value", snap => {
  if(snap.val()) {
    gameState.timeUp = true;
    Object.keys(sections).forEach(sec => {
      if(!gameState.lockedSections[sec]) db.ref("game/lockedSections/"+sec).set("timeUp");
    });
    showScore();
  }
});

function updateTimerDisplay(seconds) {
  const min = Math.floor(seconds/60).toString().padStart(2,'0');
  const sec = (seconds%60).toString().padStart(2,'0');
  document.getElementById("timer").textContent = `‚è±Ô∏è ${min}:${sec}`;
}

/* ========== SCORE SCREEN ========== */
function showScore() {
  showScreen("scoreScreen");

  db.ref("game").once("value").then(snap => {
    const d = snap.val() || {};
    const redScore = d.redScore || 0;
    const blueScore = d.blueScore || 0;
    const lockedSections = d.lockedSections || {};

    let winner = "Tie ü§ù";
    if(redScore > blueScore) winner = "Red Team üî¥";
    else if(blueScore > redScore) winner = "Blue Team üîµ";

    let redSections="", blueSections="";
    Object.keys(sections).forEach(sec => {
      const takenBy = lockedSections[sec];
      if(takenBy==="red") redSections+=`‚úîÔ∏è ${sec}<br>`;
      else if(takenBy==="blue") blueSections+=`‚úîÔ∏è ${sec}<br>`;
      else if(takenBy==="timeUp") redSections+=`‚è∞ ${sec} (Not Finished)<br>`, blueSections+=`‚è∞ ${sec} (Not Finished)<br>`;
    });

    document.getElementById("scoreText").innerHTML = `
      <div style="font-size:20px; margin:15px 0;">
        <b>üî¥ Red Team:</b> ${redScore} points<br>Completed Sections:<br>${redSections}<br>
        <b>üîµ Blue Team:</b> ${blueScore} points<br>Completed Sections:<br>${blueSections}<br>
      </div>
      <div style="font-size:24px; margin:20px 0; color:#4caf50;">
        Winner: ${winner}
      </div>
    `;
  });
}

/* ========== RESET ========== */
function resetGame() {
  db.ref("game").remove().then(()=>window.location.reload());
}

/* ========== SCREEN SWITCH ========== */
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
</script>
</body>
</html>
