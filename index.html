<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Red vs Blue Islamic Game</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background:#f0f4f8; text-align:center; margin:0; }
  h1 { margin-top:20px; color:#333; }
  .screen { display:none; padding:20px; transition: all 0.3s ease; }
  .active { display:block; }
  .team-btn { padding:20px 50px; margin:20px; font-size:22px; border:none; color:white; border-radius:15px; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.2); transition:0.3s; }
  .team-btn:hover { transform: translateY(-3px); }
  .team-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .red { background:#e53935; }
  .blue { background:#1e88e5; }
  .section { background:white; padding:20px; margin:15px auto; width:80%; max-width:450px; border-radius:15px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.15); transition:0.2s; }
  .section:hover { transform: translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.2); }
  .locked { background:#ddd; cursor:not-allowed; }
  #questionBox { background:white; padding:25px; width:85%; max-width:500px; margin:20px auto; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  #questionBox button { padding:12px 25px; margin:10px; font-size:18px; cursor:pointer; border:none; border-radius:10px; transition:0.2s; background:#2196f3; color:white; }
  #questionBox button:hover { transform: scale(1.05); }
  #scoreScreen button { padding:15px 30px; font-size:20px; background:#ff9800; color:white; border:none; border-radius:12px; cursor:pointer; transition:0.2s; }
  #scoreScreen button:hover { transform: translateY(-3px); }
  .current-score { position: fixed; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .waiting { color: #666; font-style: italic; }
</style>
</head>
<body>

<h1>Red vs Blue Islamic Game</h1>

<div class="current-score" id="liveScore" style="display:none;">
  <div>üî¥ Red: <span id="redScoreLive">0</span></div>
  <div>üîµ Blue: <span id="blueScoreLive">0</span></div>
</div>

<!-- TEAM SELECTION -->
<div id="teamScreen" class="screen active">
  <h2>Choose your team</h2>
  <p id="teamStatus">Waiting for both teams to join...</p>
  <button class="team-btn red" id="redBtn" onclick="joinTeam('red')">Red Team üî¥</button>
  <button class="team-btn blue" id="blueBtn" onclick="joinTeam('blue')">Blue Team üîµ</button>
  <p class="waiting" id="waitingMsg" style="display:none;">Waiting for other team...</p>
</div>

<!-- SECTION SELECTION -->
<div id="sectionScreen" class="screen">
  <h2 id="sectionTitle">Pick a Section</h2>
  <div id="sections"></div>
</div>

<!-- QUESTION SCREEN -->
<div id="questionScreen" class="screen">
  <div id="questionBox"></div>
</div>

<!-- SCORE SCREEN -->
<div id="scoreScreen" class="screen">
  <h2>Final Score</h2>
  <p id="scoreText"></p>
  <button onclick="resetGame()">Restart Game</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ========== FIREBASE CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAKP0ovl9ZERz9pHgdy-bNSD8GDtvDjmnc",
  authDomain: "athome-8dca5.firebaseapp.com",
  databaseURL: "https://athome-8dca5-default-rtdb.firebaseio.com",
  projectId: "athome-8dca5",
  storageBucket: "athome-8dca5.firebasestorage.app",
  messagingSenderId: "720555193634",
  appId: "1:720555193634:web:262b9a01b9dc3191cca17b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== GAME STATE ========== */
let gameState = {
  team: null,
  currentQuestion: null,
  lockedSections: {}
};

/* ========== SECTIONS + QUESTIONS ========== */
const sections = {
  "ÿßŸÑŸÜÿ∏ÿßŸÅÿ© ŸÅŸä ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ": [
    { type:"tf", q:"ÿßŸÑŸÜÿ∏ÿßŸÅÿ© ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑÿ•ŸäŸÖÿßŸÜÿü", a:true },
    { type:"mcq", q:"ÿ£Ÿä ŸÖŸÜ ÿßŸÑÿ™ÿßŸÑŸä ŸÖÿ´ÿßŸÑ ÿπŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÅÿ© ŸÅŸä ÿßŸÑÿ≥ŸÜÿ©ÿü", a:"Ÿàÿ∂Ÿàÿ°", options:["Ÿàÿ∂Ÿàÿ°","ÿµŸÑÿßÿ©","ÿµŸàŸÖ"] },
    { type:"hadith", q:"ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ÿØŸäÿ´ ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿπŸÜ ÿßŸÑŸÜÿ∏ÿßŸÅÿ©", a:"ÿßŸÑÿ∑ŸáŸàÿ± ÿ¥ÿ∑ÿ± ÿßŸÑÿ•ŸäŸÖÿßŸÜ", options:["ÿßŸÑÿ∑ŸáŸàÿ± ÿ¥ÿ∑ÿ± ÿßŸÑÿ•ŸäŸÖÿßŸÜ","ÿßŸÑÿµŸÑÿßÿ© ÿπŸÖŸàÿØ ÿßŸÑÿØŸäŸÜ","ÿßŸÑÿµŸàŸÖ ÿ¨ŸÜÿ©"] }
  ],
  "ÿßŸÑÿ™ÿ±ŸÅ ŸàÿßŸÑŸÖÿ∏ÿßŸáÿ± ÿßŸÑŸàÿ´ŸÜŸäÿ©": [
    { type:"tf", q:"ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ Ÿäÿ≠ÿ∞ÿ± ŸÖŸÜ ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ÿ© ŸÅŸä ÿßŸÑÿ≤ŸäŸÜÿ©ÿü", a:true },
    { type:"mcq", q:"ÿ£Ÿä ŸÖŸàŸÇŸÅ ŸÖŸÜ ÿßŸÑÿ™ÿßŸÑŸä ÿµÿ≠Ÿäÿ≠ÿü", a:"ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ Ÿäÿ≠ÿ∞ÿ± ŸÖŸÜ ÿßŸÑÿ™ÿ¥ÿ®Ÿá ÿ®ÿßŸÑŸàÿ´ŸÜŸäŸäŸÜ", options:["ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ Ÿäÿ¥ÿ¨ÿπ ÿßŸÑÿ™ÿ±ŸÅ","ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ Ÿäÿ≠ÿ∞ÿ± ŸÖŸÜ ÿßŸÑÿ™ÿ¥ÿ®Ÿá ÿ®ÿßŸÑŸàÿ´ŸÜŸäŸäŸÜ","ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ ŸÑÿß ŸäŸáÿ™ŸÖ"] },
    { type:"hadith", q:"ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ÿØŸäÿ´ ÿßŸÑÿµÿ≠Ÿäÿ≠", a:"ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ÿ© ŸÅŸä ÿßŸÑÿ≤ŸäŸÜÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ±ŸÖÿßÿ™", options:["ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ÿ© ŸÅŸä ÿßŸÑÿ≤ŸäŸÜÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ±ŸÖÿßÿ™","ÿßŸÑÿµÿØŸÇÿ© Ÿàÿßÿ¨ÿ®ÿ©","ÿßŸÑÿµŸÑÿßÿ© ŸÅÿ±ÿ∂"] }
  ],
  "ÿ¢ŸÜŸäÿ© ÿßŸÑÿ∞Ÿáÿ® ŸàÿßŸÑŸÅÿ∂ÿ©": [
    { type:"tf", q:"ÿ£ŸÉŸÑ Ÿàÿ¥ÿ±ÿ® ÿßŸÑÿ∞Ÿáÿ® ŸàÿßŸÑŸÅÿ∂ÿ© ÿ≠ÿ±ÿßŸÖÿü", a:true },
    { type:"mcq", q:"ŸÖÿß ÿ≥ÿ®ÿ® ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖÿü", a:"ÿßŸÑÿ™ŸÅÿßÿÆÿ± ŸàÿßŸÑÿ®ÿ∞ÿÆ", options:["ÿßŸÑÿ™ŸÅÿßÿÆÿ± ŸàÿßŸÑÿ®ÿ∞ÿÆ","ÿßŸÑÿ≤ŸäŸÜÿ© ŸÅŸÇÿ∑","ŸÑÿß ÿ™ÿ≠ÿ±ŸÖ"] },
    { type:"hadith", q:"ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ÿØŸäÿ´ ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿπŸÜ ÿ£ŸàÿßŸÜŸä ÿßŸÑÿ∞Ÿáÿ® ŸàÿßŸÑŸÅÿ∂ÿ©", a:"ŸÑÿπŸÜ ÿßŸÑŸÑŸá ÿ¢ŸÉŸÑŸäŸáÿß ŸàÿßŸÑŸÖÿ£ŸÉŸàŸÑŸäŸÜ ŸÖŸÜŸáÿß", options:["ŸÑÿπŸÜ ÿßŸÑŸÑŸá ÿ¢ŸÉŸÑŸäŸáÿß ŸàÿßŸÑŸÖÿ£ŸÉŸàŸÑŸäŸÜ ŸÖŸÜŸáÿß","ÿßŸÑÿµŸàŸÖ ÿ¨ŸÜÿ©","ÿßŸÑÿµŸÑÿßÿ© ÿπŸÖŸàÿØ ÿßŸÑÿØŸäŸÜ"] }
  ]
};

/* ========== CONNECTION ========== */
const myID = "u_" + Math.random().toString(36).substr(2,9);
db.ref("game/players/"+myID).set(true);
db.ref("game/players/"+myID).onDisconnect().remove();

/* ========== TEAM JOIN ========== */
function joinTeam(team) {
  gameState.team = team;

  // Initialize scores if they don't exist
  db.ref("game/redScore").once("value").then(snap => {
    if(snap.val() === null) db.ref("game/redScore").set(0);
  });
  db.ref("game/blueScore").once("value").then(snap => {
    if(snap.val() === null) db.ref("game/blueScore").set(0);
  });

  // Mark team as joined
  db.ref("game/teams/"+team).set({ joined: true, count: firebase.database.ServerValue.increment(1) });

  // Update UI
  document.getElementById("redBtn").disabled = true;
  document.getElementById("blueBtn").disabled = true;
  document.getElementById("waitingMsg").style.display = "block";

  console.log("Joined team:", team);
}

/* ========== LISTEN TEAMS ========== */
db.ref("game/teams").on("value", snap => {
  const data = snap.val() || {};
  const redJoined = data.red?.joined || false;
  const blueJoined = data.blue?.joined || false;

  document.getElementById("teamStatus").innerHTML = `Red: ${redJoined?"‚úîÔ∏è":"‚ùå"} | Blue: ${blueJoined?"‚úîÔ∏è":"‚ùå"}`;

  // Both teams ready - start game
  if(redJoined && blueJoined && gameState.team) {
    showScreen("sectionScreen");
    document.getElementById("liveScore").style.display = "block";
    loadSections();
  }
});

/* ========== LISTEN SCORES ========== */
db.ref("game/redScore").on("value", snap => {
  const score = snap.val() || 0;
  document.getElementById("redScoreLive").textContent = score;
});

db.ref("game/blueScore").on("value", snap => {
  const score = snap.val() || 0;
  document.getElementById("blueScoreLive").textContent = score;
});

/* ========== SECTIONS ========== */
db.ref("game/lockedSections").on("value", snap => {
  gameState.lockedSections = snap.val() || {};
  if(document.getElementById("sectionScreen").classList.contains("active")) {
    loadSections();
  }

  // Check if all sections are taken
  const totalSections = Object.keys(sections).length;
  const takenSections = Object.keys(gameState.lockedSections).length;

  if(takenSections === totalSections) {
    showScore();
  }
});

function loadSections() {
  const container = document.getElementById("sections");
  container.innerHTML = "";

  document.getElementById("sectionTitle").innerHTML = `${gameState.team === "red" ? "Red Team üî¥" : "Blue Team üîµ"} - Pick a Section`;

  Object.keys(sections).forEach(sec => {
    const div = document.createElement("div");
    div.className = "section";

    const takenBy = gameState.lockedSections[sec];

    if(takenBy) {
      div.innerHTML = sec + ` ${takenBy === "red" ? "üî¥" : "üîµ"} (Taken)`;
      div.classList.add("locked");
      div.onclick = null;
    } else {
      div.innerHTML = sec;
      div.onclick = () => pickSection(sec);
    }

    container.appendChild(div);
  });
}

function pickSection(sec) {
  if(gameState.lockedSections[sec]) return;

  // Lock this section for this team
  db.ref("game/lockedSections/"+sec).set(gameState.team);

  // Get random question from section
  const qList = sections[sec];
  const q = qList[Math.floor(Math.random() * qList.length)];
  gameState.currentQuestion = { ...q, section: sec };

  showQuestion(q);
}

/* ========== QUESTIONS ========== */
function showQuestion(q) {
  showScreen("questionScreen");
  let html = `<h3>${gameState.team === "red" ? "Red Team üî¥" : "Blue Team üîµ"}</h3><p style="font-size:20px; margin:20px 0;">${q.q}</p>`;

  if(q.type === "tf") {
    html += `<button onclick="answer(true)">‚úîÔ∏è True</button>
             <button onclick="answer(false)">‚ùå False</button>`;
  } else if(q.type === "mcq" || q.type === "hadith") {
    q.options.forEach(opt => {
      html += `<button onclick="answer('${opt.replace(/'/g, "\\'")}')">${opt}</button>`;
    });
  }

  document.getElementById("questionBox").innerHTML = html;
}

/* ========== ANSWERS + SCORE ========== */
function answer(selected) {
  const q = gameState.currentQuestion;
  if(!q) return;

  let isCorrect = false;

  if(typeof q.a === "boolean") {
    isCorrect = (selected === q.a);
  } else {
    isCorrect = (selected === q.a);
  }

  // Update score if correct
  if(isCorrect) {
    const scorePath = `game/${gameState.team}Score`;
    db.ref(scorePath).transaction(currentScore => {
      return (currentScore || 0) + 1;
    });

    alert("‚úîÔ∏è Correct!");
  } else {
    alert("‚ùå Wrong! The correct answer was: " + q.a);
  }

  // Clear current question
  gameState.currentQuestion = null;

  // Check if game is over
  db.ref("game/lockedSections").once("value").then(snap => {
    const taken = Object.keys(snap.val() || {}).length;
    const total = Object.keys(sections).length;

    if(taken === total) {
      showScore();
    } else {
      showScreen("sectionScreen");
      loadSections();
    }
  });
}

/* ========== SCORE SCREEN ========== */
function showScore() {
  showScreen("scoreScreen");

  db.ref("game").once("value").then(snap => {
    const d = snap.val() || {};
    const redScore = d.redScore || 0;
    const blueScore = d.blueScore || 0;

    let winner = "Tie ü§ù";
    if(redScore > blueScore) winner = "Red Team üî¥";
    else if(blueScore > redScore) winner = "Blue Team üîµ";

    document.getElementById("scoreText").innerHTML = `
      <div style="font-size:24px; margin:20px 0;">
        üî¥ Red Team: ${redScore}<br>
        üîµ Blue Team: ${blueScore}<br><br>
        <b style="font-size:32px; color:#4caf50;">Winner: ${winner}</b>
      </div>
    `;
  });
}

/* ========== RESET ========== */
function resetGame() {
  db.ref("game").remove().then(() => {
    window.location.reload();
  });
}

/* ========== SCREEN SWITCH ========== */
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
</script>
</body>
</html>
